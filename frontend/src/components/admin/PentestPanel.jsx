import { useState, useEffect, useCallback } from "react";
import axios from "axios";
import { Plus, Trash2, ChevronDown, ChevronUp, X, AlertTriangle, Shield } from "lucide-react";

const API = process.env.REACT_APP_BACKEND_URL + "/api";

const severityColors = {
  critical: "#ff4444", high: "#ff6600", medium: "#ffaa00", low: "#00aaff", info: "#555"
};
const statusColors = {
  active: "#00ff88", inactive: "#555", completed: "#00aaff"
};

export default function PentestPanel() {
  const [targets, setTargets] = useState([]);
  const [scans, setScans] = useState([]);
  const [vulns, setVulns] = useState([]);
  const [expandedTarget, setExpandedTarget] = useState(null);
  const [activeTab, setActiveTab] = useState("targets"); // targets, scans, vulns
  const [newTarget, setNewTarget] = useState({ host: "", description: "", ports: "", status: "active" });
  const [newScan, setNewScan] = useState({ target_id: "", scan_type: "", results: "", notes: "", status: "pending" });
  const [newVuln, setNewVuln] = useState({ target_id: "", title: "", severity: "medium", description: "", cvss: 0, status: "open" });
  const [showForm, setShowForm] = useState(false);

  const load = useCallback(async () => {
    try {
      const [tr, sr, vr] = await Promise.all([
        axios.get(`${API}/targets`),
        axios.get(`${API}/scans`),
        axios.get(`${API}/vulnerabilities`),
      ]);
      setTargets(tr.data);
      setScans(sr.data);
      setVulns(vr.data);
    } catch (_) {}
  }, []);

  useEffect(() => { load(); }, [load]);

  const addTarget = async () => {
    if (!newTarget.host) return;
    try {
      const r = await axios.post(`${API}/targets`, newTarget);
      setTargets(prev => [r.data, ...prev]);
      setNewTarget({ host: "", description: "", ports: "", status: "active" });
      setShowForm(false);
    } catch (_) {}
  };

  const deleteTarget = async (id) => {
    try {
      await axios.delete(`${API}/targets/${id}`);
      setTargets(prev => prev.filter(t => t.id !== id));
      setScans(prev => prev.filter(s => s.target_id !== id));
      setVulns(prev => prev.filter(v => v.target_id !== id));
    } catch (_) {}
  };

  const addScan = async () => {
    if (!newScan.target_id || !newScan.scan_type) return;
    try {
      const r = await axios.post(`${API}/scans`, newScan);
      setScans(prev => [r.data, ...prev]);
      setNewScan({ target_id: "", scan_type: "", results: "", notes: "", status: "pending" });
      setShowForm(false);
    } catch (_) {}
  };

  const deleteScan = async (id) => {
    try {
      await axios.delete(`${API}/scans/${id}`);
      setScans(prev => prev.filter(s => s.id !== id));
    } catch (_) {}
  };

  const addVuln = async () => {
    if (!newVuln.target_id || !newVuln.title) return;
    try {
      const r = await axios.post(`${API}/vulnerabilities`, newVuln);
      setVulns(prev => [r.data, ...prev]);
      setNewVuln({ target_id: "", title: "", severity: "medium", description: "", cvss: 0, status: "open" });
      setShowForm(false);
    } catch (_) {}
  };

  const deleteVuln = async (id) => {
    try {
      await axios.delete(`${API}/vulnerabilities/${id}`);
      setVulns(prev => prev.filter(v => v.id !== id));
    } catch (_) {}
  };

  const inputStyle = {
    background: "#080808", border: "1px solid #1a1a1a", color: "#ccc",
    padding: "0.45rem 0.6rem", fontFamily: "'JetBrains Mono', monospace",
    fontSize: "0.75rem", outline: "none"
  };

  const targetName = (id) => targets.find(t => t.id === id)?.host || id;

  return (
    <div data-testid="pentest-panel" className="slide-up">
      {/* Tabs */}
      <div style={{ display: "flex", gap: "0.3rem", marginBottom: "1.25rem" }}>
        {[
          { id: "targets", label: `TARGETS (${targets.length})` },
          { id: "scans", label: `SCANS (${scans.length})` },
          { id: "vulns", label: `VULNERABILITIES (${vulns.length})` },
        ].map(({ id, label }) => (
          <button
            key={id}
            data-testid={`pentest-tab-${id}`}
            onClick={() => { setActiveTab(id); setShowForm(false); }}
            style={{
              background: activeTab === id ? "#0a1a0a" : "transparent",
              color: activeTab === id ? "#00ff88" : "#444",
              border: `1px solid ${activeTab === id ? "#00ff8833" : "#1a1a1a"}`,
              padding: "0.4rem 0.8rem", fontSize: "0.65rem", cursor: "pointer",
              fontFamily: "'JetBrains Mono', monospace", letterSpacing: "0.15em"
            }}
          >
            {label}
          </button>
        ))}
        <button
          onClick={() => setShowForm(!showForm)}
          data-testid="pentest-add-btn"
          style={{
            marginLeft: "auto", background: "#00ff88", color: "#000", border: "none",
            padding: "0.4rem 0.9rem", fontSize: "0.65rem", fontWeight: 700,
            cursor: "pointer", fontFamily: "'JetBrains Mono', monospace",
            letterSpacing: "0.15em", display: "flex", alignItems: "center", gap: "0.4rem"
          }}
        >
          <Plus size={12} /> ADD {activeTab.slice(0, -1).toUpperCase()}
        </button>
      </div>

      {/* Add form */}
      {showForm && (
        <div style={{ background: "#080808", border: "1px solid #1a1a1a", padding: "1rem", marginBottom: "1rem" }}>
          <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "0.75rem" }}>
            <span style={{ color: "#00ff88", fontSize: "0.7rem", letterSpacing: "0.2em" }}>
              ADD {activeTab.slice(0, -1).toUpperCase()}
            </span>
            <button onClick={() => setShowForm(false)} style={{ background: "none", border: "none", color: "#444", cursor: "pointer" }}>
              <X size={14} />
            </button>
          </div>

          {/* Target form */}
          {activeTab === "targets" && (
            <div style={{ display: "grid", gap: "0.5rem" }}>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0.5rem" }}>
                <input data-testid="target-host" placeholder="Host / IP / Domain" value={newTarget.host}
                  onChange={e => setNewTarget(p => ({ ...p, host: e.target.value }))} style={{ ...inputStyle, width: "100%" }} />
                <input data-testid="target-ports" placeholder="Ports (e.g. 80,443,8080)" value={newTarget.ports}
                  onChange={e => setNewTarget(p => ({ ...p, ports: e.target.value }))} style={{ ...inputStyle, width: "100%" }} />
              </div>
              <input data-testid="target-desc" placeholder="Description" value={newTarget.description}
                onChange={e => setNewTarget(p => ({ ...p, description: e.target.value }))} style={{ ...inputStyle, width: "100%" }} />
              <div style={{ display: "flex", gap: "0.5rem", alignItems: "center" }}>
                <select data-testid="target-status" value={newTarget.status}
                  onChange={e => setNewTarget(p => ({ ...p, status: e.target.value }))} style={{ ...inputStyle }}>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="completed">Completed</option>
                </select>
                <button onClick={addTarget} data-testid="submit-target" style={{
                  background: "#00ff88", color: "#000", border: "none", padding: "0.45rem 1rem",
                  fontSize: "0.7rem", fontWeight: 700, cursor: "pointer", fontFamily: "'JetBrains Mono', monospace"
                }}>ADD TARGET</button>
              </div>
            </div>
          )}

          {/* Scan form */}
          {activeTab === "scans" && (
            <div style={{ display: "grid", gap: "0.5rem" }}>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0.5rem" }}>
                <select data-testid="scan-target" value={newScan.target_id}
                  onChange={e => setNewScan(p => ({ ...p, target_id: e.target.value }))} style={{ ...inputStyle }}>
                  <option value="">Select Target</option>
                  {targets.map(t => <option key={t.id} value={t.id}>{t.host}</option>)}
                </select>
                <input data-testid="scan-type" placeholder="Scan type (nmap, nikto, dirb...)" value={newScan.scan_type}
                  onChange={e => setNewScan(p => ({ ...p, scan_type: e.target.value }))} style={{ ...inputStyle, width: "100%" }} />
              </div>
              <textarea data-testid="scan-results" placeholder="Results / Output" value={newScan.results}
                onChange={e => setNewScan(p => ({ ...p, results: e.target.value }))} rows={3}
                style={{ ...inputStyle, width: "100%", resize: "vertical" }} />
              <div style={{ display: "flex", gap: "0.5rem", alignItems: "center" }}>
                <select data-testid="scan-status" value={newScan.status}
                  onChange={e => setNewScan(p => ({ ...p, status: e.target.value }))} style={{ ...inputStyle }}>
                  <option value="pending">Pending</option>
                  <option value="running">Running</option>
                  <option value="completed">Completed</option>
                  <option value="failed">Failed</option>
                </select>
                <button onClick={addScan} data-testid="submit-scan" style={{
                  background: "#00ff88", color: "#000", border: "none", padding: "0.45rem 1rem",
                  fontSize: "0.7rem", fontWeight: 700, cursor: "pointer", fontFamily: "'JetBrains Mono', monospace"
                }}>ADD SCAN</button>
              </div>
            </div>
          )}

          {/* Vuln form */}
          {activeTab === "vulns" && (
            <div style={{ display: "grid", gap: "0.5rem" }}>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "0.5rem" }}>
                <select data-testid="vuln-target" value={newVuln.target_id}
                  onChange={e => setNewVuln(p => ({ ...p, target_id: e.target.value }))} style={{ ...inputStyle }}>
                  <option value="">Select Target</option>
                  {targets.map(t => <option key={t.id} value={t.id}>{t.host}</option>)}
                </select>
                <select data-testid="vuln-severity" value={newVuln.severity}
                  onChange={e => setNewVuln(p => ({ ...p, severity: e.target.value }))} style={{ ...inputStyle }}>
                  {["critical", "high", "medium", "low", "info"].map(s => <option key={s} value={s}>{s.toUpperCase()}</option>)}
                </select>
                <input data-testid="vuln-cvss" type="number" min="0" max="10" step="0.1" placeholder="CVSS Score"
                  value={newVuln.cvss} onChange={e => setNewVuln(p => ({ ...p, cvss: parseFloat(e.target.value) || 0 }))}
                  style={{ ...inputStyle, width: "100%" }} />
              </div>
              <input data-testid="vuln-title" placeholder="Vulnerability Title" value={newVuln.title}
                onChange={e => setNewVuln(p => ({ ...p, title: e.target.value }))} style={{ ...inputStyle, width: "100%" }} />
              <textarea data-testid="vuln-desc" placeholder="Description / POC" value={newVuln.description}
                onChange={e => setNewVuln(p => ({ ...p, description: e.target.value }))} rows={3}
                style={{ ...inputStyle, width: "100%", resize: "vertical" }} />
              <div style={{ display: "flex", gap: "0.5rem" }}>
                <select data-testid="vuln-status" value={newVuln.status}
                  onChange={e => setNewVuln(p => ({ ...p, status: e.target.value }))} style={{ ...inputStyle }}>
                  <option value="open">Open</option>
                  <option value="in-progress">In Progress</option>
                  <option value="resolved">Resolved</option>
                </select>
                <button onClick={addVuln} data-testid="submit-vuln" style={{
                  background: "#00ff88", color: "#000", border: "none", padding: "0.45rem 1rem",
                  fontSize: "0.7rem", fontWeight: 700, cursor: "pointer", fontFamily: "'JetBrains Mono', monospace"
                }}>ADD VULN</button>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Targets list */}
      {activeTab === "targets" && (
        <div style={{ display: "grid", gap: "0.5rem" }}>
          {targets.length === 0 && <div style={{ color: "#222", textAlign: "center", padding: "2rem", border: "1px dashed #111" }}>No targets added</div>}
          {targets.map(t => (
            <div key={t.id} data-testid={`target-${t.id}`} style={{ background: "#080808", border: "1px solid #111" }}>
              <div style={{ display: "flex", alignItems: "center", gap: "0.75rem", padding: "0.75rem 1rem", cursor: "pointer" }}
                onClick={() => setExpandedTarget(expandedTarget === t.id ? null : t.id)}>
                <div style={{ width: "7px", height: "7px", borderRadius: "50%", background: statusColors[t.status] || "#555" }} />
                <div style={{ flex: 1 }}>
                  <div style={{ color: "#ccc", fontSize: "0.8rem", fontFamily: "monospace" }}>{t.host}</div>
                  <div style={{ color: "#444", fontSize: "0.65rem" }}>{t.description} {t.ports && `| Ports: ${t.ports}`}</div>
                </div>
                <span style={{ color: statusColors[t.status], fontSize: "0.6rem", letterSpacing: "0.15em" }}>{t.status?.toUpperCase()}</span>
                <span style={{ color: "#333", fontSize: "0.65rem" }}>
                  {scans.filter(s => s.target_id === t.id).length} scans,{" "}
                  {vulns.filter(v => v.target_id === t.id).length} vulns
                </span>
                {expandedTarget === t.id ? <ChevronUp size={14} color="#444" /> : <ChevronDown size={14} color="#444" />}
                <button onClick={(e) => { e.stopPropagation(); deleteTarget(t.id); }}
                  style={{ background: "none", border: "none", color: "#ff444466", cursor: "pointer" }}>
                  <Trash2 size={13} />
                </button>
              </div>
              {expandedTarget === t.id && (
                <div style={{ borderTop: "1px solid #111", padding: "0.75rem 1rem", background: "#050505" }}>
                  <div style={{ color: "#333", fontSize: "0.65rem", marginBottom: "0.5rem" }}>
                    Added: {t.created_at?.slice(0, 16).replace("T", " ")}
                  </div>
                  {vulns.filter(v => v.target_id === t.id).map(v => (
                    <div key={v.id} style={{ display: "flex", alignItems: "center", gap: "0.5rem", marginBottom: "0.25rem" }}>
                      <AlertTriangle size={10} color={severityColors[v.severity]} />
                      <span style={{ color: severityColors[v.severity], fontSize: "0.6rem", letterSpacing: "0.1em" }}>
                        [{v.severity?.toUpperCase()}]
                      </span>
                      <span style={{ color: "#666", fontSize: "0.68rem" }}>{v.title}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      {/* Scans list */}
      {activeTab === "scans" && (
        <div style={{ background: "#080808", border: "1px solid #111" }}>
          {scans.length === 0 && <div style={{ color: "#222", textAlign: "center", padding: "2rem" }}>No scans recorded</div>}
          {scans.map(s => (
            <div key={s.id} data-testid={`scan-${s.id}`} style={{ padding: "0.75rem 1rem", borderBottom: "1px solid #0a0a0a", display: "flex", gap: "0.75rem", alignItems: "flex-start" }}>
              <Shield size={13} color="#555" style={{ marginTop: "2px" }} />
              <div style={{ flex: 1 }}>
                <div style={{ color: "#ccc", fontSize: "0.75rem" }}>
                  <span style={{ color: "#00ff8888", fontFamily: "monospace" }}>{s.scan_type}</span>
                  {" on "}<span style={{ color: "#888" }}>{targetName(s.target_id)}</span>
                </div>
                {s.results && <div style={{ color: "#444", fontSize: "0.65rem", marginTop: "0.25rem", fontFamily: "monospace", whiteSpace: "pre-wrap" }}>{s.results?.slice(0, 200)}</div>}
                <div style={{ color: "#333", fontSize: "0.6rem", marginTop: "0.25rem" }}>{s.started_at?.slice(0, 16).replace("T", " ")}</div>
              </div>
              <span style={{
                fontSize: "0.6rem", letterSpacing: "0.1em", border: "1px solid",
                padding: "2px 6px",
                color: s.status === "completed" ? "#00ff88" : s.status === "running" ? "#ffaa00" : s.status === "failed" ? "#ff4444" : "#555",
                borderColor: s.status === "completed" ? "#00ff8833" : s.status === "running" ? "#ffaa0033" : s.status === "failed" ? "#ff444433" : "#1a1a1a"
              }}>{s.status?.toUpperCase()}</span>
              <button onClick={() => deleteScan(s.id)} style={{ background: "none", border: "none", color: "#ff444466", cursor: "pointer" }}>
                <Trash2 size={12} />
              </button>
            </div>
          ))}
        </div>
      )}

      {/* Vulns list */}
      {activeTab === "vulns" && (
        <div style={{ background: "#080808", border: "1px solid #111" }}>
          {vulns.length === 0 && <div style={{ color: "#222", textAlign: "center", padding: "2rem" }}>No vulnerabilities recorded</div>}
          {vulns.map(v => (
            <div key={v.id} data-testid={`vuln-${v.id}`} style={{ padding: "0.75rem 1rem", borderBottom: "1px solid #0a0a0a", display: "flex", gap: "0.75rem", alignItems: "flex-start" }}>
              <AlertTriangle size={13} color={severityColors[v.severity]} style={{ marginTop: "2px" }} />
              <div style={{ flex: 1 }}>
                <div style={{ display: "flex", alignItems: "center", gap: "0.5rem", marginBottom: "0.25rem" }}>
                  <span style={{
                    color: severityColors[v.severity], fontSize: "0.6rem", border: "1px solid",
                    borderColor: severityColors[v.severity] + "33", padding: "1px 5px", letterSpacing: "0.1em"
                  }}>{v.severity?.toUpperCase()}</span>
                  {v.cvss > 0 && <span style={{ color: "#555", fontSize: "0.6rem" }}>CVSS: {v.cvss}</span>}
                  <span style={{ color: "#555", fontSize: "0.6rem" }}>â€” {targetName(v.target_id)}</span>
                </div>
                <div style={{ color: "#ccc", fontSize: "0.78rem" }}>{v.title}</div>
                {v.description && <div style={{ color: "#444", fontSize: "0.65rem", marginTop: "0.2rem" }}>{v.description?.slice(0, 120)}</div>}
              </div>
              <span style={{ fontSize: "0.6rem", color: v.status === "resolved" ? "#00ff88" : "#555", letterSpacing: "0.1em" }}>
                {v.status?.toUpperCase()}
              </span>
              <button onClick={() => deleteVuln(v.id)} style={{ background: "none", border: "none", color: "#ff444466", cursor: "pointer" }}>
                <Trash2 size={12} />
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
